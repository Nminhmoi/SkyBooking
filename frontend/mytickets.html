<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Vé của tôi - SkyBook</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="assets/css/style.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark custom-navbar shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">SkyBook</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navContent">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navContent">
      <ul class="navbar-nav ms-auto align-items-center" id="navRightArea"></ul>
    </div>
  </div>
</nav>

<div class="container py-5">
  <h2 class="mb-4 text-center fw-bold text-primary">VÉ ĐÃ ĐẶT CỦA TÔI</h2>

  <div id="ticketList" class="row g-4 justify-content-center">
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">Đang tải dữ liệu...</p>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async function(){
  
  // 1. Check Login
  const user = JSON.parse(localStorage.getItem("loggedInUser") || "null");
  const token = localStorage.getItem("token");
  const navRight = document.getElementById("navRightArea");

  if(!user || !token){
    alert("Vui lòng đăng nhập!");
    window.location.href = "login.html";
    return;
  }

  // Render Navbar
  navRight.innerHTML = `
    <li class="nav-item d-flex align-items-center me-3 text-white">Xin chào, <strong class="ms-2">${user.name}</strong></li>
    <li class="nav-item"><a class="nav-link active fw-bold text-warning" href="#">Vé đã đặt</a></li>
    <li class="nav-item"><button id="logoutBtn" class="btn btn-outline-light ms-2">Đăng xuất</button></li>
  `;
  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("loggedInUser");
    localStorage.removeItem("token");
    window.location.href = "index.html";
  });

  // 2. GỌI API LẤY DANH SÁCH VÉ
  const ticketListEl = document.getElementById("ticketList");

  try {
    const res = await fetch('http://localhost:5000/api/bookings/my-tickets', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'x-auth-token': token
        }
    });

    const resData = await res.json();
    
    console.log("Status:", res.status);
    console.log("Dữ liệu Server trả về:", resData); 

    // Nếu response không thành công
    if(!res.ok) {
        console.error("Lỗi API:", res.status, resData);
        ticketListEl.innerHTML = `<div class="col-12">
            <div class="alert alert-danger text-center">
                <strong>Lỗi Backend (${res.status}):</strong><br>${resData.message || 'Không có thông tin lỗi'}
            </div>
        </div>`;
        return;
    }

    // --- SỬA LẠI ĐOẠN LẤY DỮ LIỆU ---
    // Kiểm tra xem dữ liệu nằm ở 'resData' hay 'resData.data'
    let tickets = [];
    
    if (Array.isArray(resData)) {
        tickets = resData; // Trường hợp trả về mảng trực tiếp
    } else if (resData.data && Array.isArray(resData.data)) {
        tickets = resData.data; // Trường hợp trả về object { success: true, data: [...] }
    } else {
        console.error("Không tìm thấy danh sách vé!", resData);
        ticketListEl.innerHTML = `<div class="col-12">
            <div class="alert alert-danger text-center">
                <strong>Lỗi:</strong> Không tìm thấy danh sách vé từ Server
            </div>
        </div>`;
        return;
    }
    // ---

    // Nếu danh sách rỗng
    if(tickets.length === 0) {
        ticketListEl.innerHTML = `
            <div class="col-12 text-center">
                <img src="https://cdn-icons-png.flaticon.com/512/4076/4076478.png" width="100" class="mb-3 opacity-50">
                <p class="text-muted">Bạn chưa đặt chuyến bay nào.</p>
                <a href="index.html" class="btn btn-primary">Đặt vé ngay</a>
            </div>
        `;
        return;
    }

    // Map qua danh sách tickets
    ticketListEl.innerHTML = tickets.map(ticket => {
        // Kiểm tra xem có thông tin chuyến bay không (đề phòng db lỗi)
        if (!ticket.flight) {
            console.warn("Vé thiếu thông tin flight:", ticket);
            return '';
        }

        const flight = ticket.flight;
        const bookingDate = new Date(ticket.bookingDate).toLocaleDateString('vi-VN');
        const flightTime = new Date(flight.startTime).toLocaleString('vi-VN');
        
        // Xử lý trạng thái và bookingCode (tránh lỗi undefined)
        const code = ticket.bookingCode || 'SKY-???';
        let statusBadge = '<span class="badge bg-success">Đã thanh toán</span>';
        if(ticket.status === 'pending') statusBadge = '<span class="badge bg-warning text-dark">Chờ thanh toán</span>';
        if(ticket.status === 'cancelled') statusBadge = '<span class="badge bg-danger">Đã hủy</span>';

        return `
        <div class="col-md-8">
            <div class="card shadow-sm border-0 h-100 overflow-hidden mb-3">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span class="fw-bold"><i class="bi bi-ticket-perforated"></i> Mã đơn: ${code}</span>
                    ${statusBadge}
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3 text-center mb-3 mb-md-0">
                            <div class="fs-1 text-primary"><i class="bi bi-airplane-engines"></i></div>
                            <div class="fw-bold text-uppercase">${flight.airline}</div>
                        </div>
                        <div class="col-md-6 border-start border-end">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="fs-5 fw-bold">${flight.from}</span>
                                <i class="bi bi-arrow-right text-muted"></i>
                                <span class="fs-5 fw-bold">${flight.to}</span>
                            </div>
                            <p class="mb-1"><i class="bi bi-clock"></i> Khởi hành: <strong>${flightTime}</strong></p>
                            <p class="mb-0"><i class="bi bi-people"></i> Hành khách: ${ticket.passengers.length} người</p>
                        </div>
                        <div class="col-md-3 text-center mt-3 mt-md-0">
                            <p class="text-muted small mb-1">Tổng tiền</p>
                            <h5 class="text-danger fw-bold">${(flight.price * ticket.passengers.length).toLocaleString('vi-VN')}đ</h5>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="alert('Tính năng in vé đang phát triển!')">
                                <i class="bi bi-printer"></i> In vé
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light text-muted small">
                    Ngày đặt: ${bookingDate}
                </div>
            </div>
        </div>
        `;
    }).join('');

  } catch (err) {
    console.error("Lỗi fetch:", err);
    ticketListEl.innerHTML = `<div class="col-12">
        <div class="alert alert-danger text-center">
            <strong>Lỗi kết nối Server!</strong><br>
            ${err.message}
        </div>
    </div>`;
  }

});
</script>
</body>
</html>